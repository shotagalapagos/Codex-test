<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>アンケート</title>
    <style>
      :root { --accent: #4f8cff; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif; margin: 24px; line-height: 1.6; }
      h1 { margin: 0 0 8px; font-size: 22px; border-bottom: 2px solid var(--accent); padding-bottom: 6px; }
      form { margin-top: 12px; max-width: 720px; }
      .q { padding: 14px 0; border-top: 1px solid #e5e5e5; }
      .q:first-of-type { border-top: none; padding-top: 0; }
      .q-title { display: block; font-weight: 600; margin-bottom: 8px; }
      .choices { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 6px; }
      .choices label { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border: 1px solid #e5e5e5; border-radius: 10px; cursor: pointer; }
      .rating { display: inline-flex; gap: 6px; }
      .rating input { margin-right: 2px; }
      button { padding: 10px 16px; border-radius: 10px; border: none; background: var(--accent); color: #fff; cursor: pointer; }
      button:hover { filter: brightness(0.95); }
      small { color: #666; }
      table.matrix { border-collapse: collapse; }
      table.matrix th, table.matrix td { border: 1px solid #e5e5e5; padding: 6px 8px; text-align: center; }
      table.matrix th { background: #f7fbff; color: #234; }
      input[type="text"], textarea { width: 100%; padding: 8px 10px; border: 1px solid #cfe0ff; border-radius: 8px; }
      input[type="text"]:focus, textarea:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
      .muted { color: #666; }
      .notice { padding: 10px 12px; border: 1px solid #cfe0ff; background: #f7fbff; border-radius: 8px; margin: 8px 0; }
    </style>
  </head>
  <body>
    <h1 id="title">アンケート</h1>
    <div id="projectInfo" class="muted"></div>
    <div id="statusMsg" class="notice" style="display:none;"></div>

    <form id="survey" novalidate>
      <section class="q">
        <label class="q-title">Q1. このサービスをどこで知りましたか？（必須）</label>
        <div class="choices" id="q1Choices"></div>
      </section>

      <section class="q" id="q2">
        <label class="q-title">Q2. <span id="q2TitleText">満足度を教えてください</span>（必須）</label>
        <div id="q2Body"></div>
        <small id="q2Hint">1〜5で評価してください</small>
      </section>

      <div class="q">
        <button type="submit">送信する</button>
      </div>
    </form>

    <script>
      // ====== ストレージとユーティリティ ======
      const INDEX_KEY = 'surveyIndexV1';
      const ACTIVE_KEY = 'activeSurveyIdV1';
      const CONFIG_KEY = (id) => `surveyConfigV1:${id}`;
      const SUB_SURVEY_KEY = (id) => `surveySubmissionsV1:survey:${id}`;
      const PROJECTS_KEY = 'surveyProjectsV1';
      const SUB_PROJECT_KEY = (pid) => `surveySubmissionsV1:project:${pid}`;

      function genId() { return 's' + Math.random().toString(36).slice(2,8) + Date.now().toString(36); }
      function parseQS() { return Object.fromEntries(new URLSearchParams(location.search).entries()); }

      const defaultConfig = {
        options: ['SNS', '検索', '友人・同僚', 'イベント', 'その他'],
        q2: {
          type: 'likert',
          titleMap: {
            'SNS': 'SNSで見た情報は役に立ちましたか？',
            '検索': '検索結果の内容は分かりやすかったですか？',
            '友人・同僚': '紹介への満足度を教えてください',
            'イベント': 'イベントの内容に満足しましたか？',
            'その他': '全体的な満足度を教えてください',
            'default': '満足度を教えてください',
          },
          hint: '1〜5で評価してください',
          likert: { points: 5, minLabel: '低い', maxLabel: '高い' },
          single: { options: ['はい', 'いいえ'] },
          multiple: { options: ['A', 'B', 'C'] },
          matrix: { rows: ['使いやすさ', 'デザイン'], cols: ['不満', '普通', '満足'], selectMode: 'single' },
          short: { placeholder: '短文で入力', preset: '', pattern: '', maxlength: 100 },
          long: { placeholder: 'ご自由に入力', preset: '', pattern: '', maxlength: 500, rows: 5 },
        },
      };

      function loadSurveyIndex() {
        const raw = localStorage.getItem(INDEX_KEY);
        if (raw) { try { const arr = JSON.parse(raw); if (Array.isArray(arr) && arr.length) return arr; } catch {} }
        const id = genId(); const name = 'アンケート 1';
        localStorage.setItem(CONFIG_KEY(id), JSON.stringify(defaultConfig));
        const idx = [{ id, name }];
        localStorage.setItem(INDEX_KEY, JSON.stringify(idx));
        localStorage.setItem(ACTIVE_KEY, id);
        return idx;
      }
      function getActiveId() { return localStorage.getItem(ACTIVE_KEY) || surveyIndex[0]?.id; }
      function loadConfig(id) {
        try {
          const raw = localStorage.getItem(CONFIG_KEY(id));
          if (!raw) return JSON.parse(JSON.stringify(defaultConfig));
          const cfg = JSON.parse(raw);
          if (!Array.isArray(cfg.options)) throw new Error('options invalid');
          if (typeof cfg.q2 !== 'object') throw new Error('q2 invalid');
          return cfg;
        } catch { return JSON.parse(JSON.stringify(defaultConfig)); }
      }
      function loadProjects() { try { return JSON.parse(localStorage.getItem(PROJECTS_KEY) || '[]'); } catch { return []; } }
      function findProject(id) { return loadProjects().find(p => p.id === id); }
      function withinRange(proj) {
        if (!proj) return true;
        const now = new Date();
        if (proj.start && new Date(proj.start) > now) return false;
        if (proj.end && new Date(proj.end) < now) return false;
        return true;
      }

      // ====== DOM参照 ======
      const form = document.getElementById('survey');
      const titleEl = document.getElementById('title');
      const projectInfo = document.getElementById('projectInfo');
      const statusMsg = document.getElementById('statusMsg');
      const q1Choices = document.getElementById('q1Choices');
      const q2TitleText = document.getElementById('q2TitleText');
      const q2Hint = document.getElementById('q2Hint');
      const q2Body = document.getElementById('q2Body');

      // ====== 起動: プロジェクト or アクティブ ======
      const surveyIndex = loadSurveyIndex();
      const qs = parseQS();
      let project = null;
      let surveyId = null;
      let submitKey = null;

      if (qs.project) {
        project = findProject(qs.project);
        if (!project) {
          statusMsg.style.display = 'block';
          statusMsg.textContent = '指定された案件は見つかりません。';
        }
        surveyId = project?.surveyId || getActiveId();
        submitKey = SUB_PROJECT_KEY(project?.id);
        titleEl.textContent = project?.name || 'アンケート';
        if (project) {
          projectInfo.textContent = `案件: ${project.name} / 状態: ${project.status || 'draft'} / 期間: ${(project.start || '-') } 〜 ${(project.end || '-')}`;
        }
      } else {
        surveyId = getActiveId();
        submitKey = SUB_SURVEY_KEY(surveyId);
        const meta = surveyIndex.find(s => s.id === surveyId);
        titleEl.textContent = meta?.name || 'アンケート';
      }

      const currentConfig = loadConfig(surveyId);

      // 案件の有効性をチェック
      let accepting = true;
      if (project) {
        const active = (project.status === 'active');
        const inRange = withinRange(project);
        accepting = active && inRange;
        if (!accepting) {
          statusMsg.style.display = 'block';
          statusMsg.textContent = '現在、このアンケートは回答募集を行っていません。';
        }
      }

      // ====== Q1描画 ======
      function renderQ1() {
        q1Choices.innerHTML = currentConfig.options.map((label, idx) => {
          const safe = escapeHtml(label);
          const required = idx === 0 ? 'required' : '';
          return `<label><input type="radio" name="discover" value="${safe}" ${required} /> ${safe}</label>`;
        }).join('');
        document.querySelectorAll('input[name="discover"]').forEach(r => r.addEventListener('change', updateQ2));
      }

      // ====== Q2描画 ======
      function renderQ2UI() {
        const t = (currentConfig.q2?.type) || 'likert';
        q2Body.innerHTML = '';
        if (t === 'likert') {
          const points = Math.max(2, Math.min(10, Number(currentConfig.q2.likert?.points ?? 5)));
          const minLabel = escapeHtml(currentConfig.q2.likert?.minLabel || '低い');
          const maxLabel = escapeHtml(currentConfig.q2.likert?.maxLabel || '高い');
          const wrap = document.createElement('div');
          const scale = document.createElement('div'); scale.className = 'rating';
          for (let i = 1; i <= points; i++) {
            const id = `likert_${i}`;
            const input = document.createElement('input'); input.type = 'radio'; input.name = 'q2'; input.value = String(i); if (i === 1) input.required = true; input.id = id;
            const label = document.createElement('label'); label.htmlFor = id; label.textContent = String(i);
            scale.appendChild(input); scale.appendChild(label);
          }
          const help = document.createElement('div'); help.style.marginTop = '6px'; help.innerHTML = `<small>${minLabel} ← 1 〜 ${points} → ${maxLabel}</small>`;
          wrap.appendChild(scale); wrap.appendChild(help);
          q2Body.appendChild(wrap);
        } else if (t === 'single') {
          const opts = currentConfig.q2.single?.options || [];
          const grid = document.createElement('div'); grid.className = 'choices';
          opts.forEach((o, idx) => {
            const id = `single_${idx}`;
            const label = document.createElement('label');
            const input = document.createElement('input'); input.type = 'radio'; input.name = 'q2'; input.value = String(o); if (idx === 0) input.required = true; input.id = id;
            label.htmlFor = id; label.appendChild(input); label.insertAdjacentText('beforeend', ' ' + String(o)); grid.appendChild(label);
          });
          q2Body.appendChild(grid);
        } else if (t === 'multiple') {
          const opts = currentConfig.q2.multiple?.options || [];
          const grid = document.createElement('div'); grid.className = 'choices';
          opts.forEach((o, idx) => {
            const id = `multi_${idx}`;
            const label = document.createElement('label');
            const input = document.createElement('input'); input.type = 'checkbox'; input.name = 'q2_multi'; input.value = String(o); input.id = id;
            label.htmlFor = id; label.appendChild(input); label.insertAdjacentText('beforeend', ' ' + String(o)); grid.appendChild(label);
          });
          q2Body.appendChild(grid);
        } else if (t === 'matrix') {
          const rows = currentConfig.q2.matrix?.rows || [];
          const cols = currentConfig.q2.matrix?.cols || [];
          const mode = currentConfig.q2.matrix?.selectMode || 'single';
          const table = document.createElement('table'); table.className = 'matrix';
          const thead = document.createElement('thead'); const trh = document.createElement('tr'); trh.appendChild(document.createElement('th'));
          cols.forEach(c => { const th = document.createElement('th'); th.textContent = String(c); trh.appendChild(th); });
          thead.appendChild(trh); table.appendChild(thead);
          const tbody = document.createElement('tbody');
          rows.forEach((r, ri) => {
            const tr = document.createElement('tr'); const th = document.createElement('th'); th.textContent = String(r); tr.appendChild(th);
            cols.forEach((c, ci) => {
              const td = document.createElement('td'); const id = `mx_${ri}_${ci}`; const input = document.createElement('input');
              input.type = (mode === 'multi') ? 'checkbox' : 'radio'; input.name = (mode === 'multi') ? `q2_row_${ri}_m` : `q2_row_${ri}`; input.value = String(c); if (ci === 0 && mode !== 'multi') input.required = true; input.id = id; td.appendChild(input); tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody); q2Body.appendChild(table);
        } else if (t === 'short') {
          const cfg = currentConfig.q2.short || {}; const input = document.createElement('input'); input.type = 'text'; input.name = 'q2'; input.required = true; if (cfg.placeholder) input.placeholder = cfg.placeholder; if (cfg.maxlength) input.maxLength = Number(cfg.maxlength); if (cfg.preset === 'numeric') input.inputMode = 'numeric'; q2Body.appendChild(input);
        } else if (t === 'long') {
          const cfg = currentConfig.q2.long || {}; const ta = document.createElement('textarea'); ta.name = 'q2'; ta.required = true; ta.rows = Number(cfg.rows || 5); if (cfg.placeholder) ta.placeholder = cfg.placeholder; if (cfg.maxlength) ta.maxLength = Number(cfg.maxlength); q2Body.appendChild(ta);
        }
      }

      function updateQ2() {
        const selected = document.querySelector('input[name="discover"]:checked');
        const key = selected ? selected.value : 'default';
        const map = currentConfig.q2?.titleMap || {};
        const title = map[key] || map.default || defaultConfig.q2.titleMap.default;
        q2TitleText.textContent = title;
        q2Hint.textContent = currentConfig.q2?.hint || defaultConfig.q2.hint;
        renderQ2UI();
      }

      // 初期描画
      (function init() {
        // Q1描画
        renderQ1();
        // Q2初期
        updateQ2();
        if (project && !accepting) {
          form.querySelectorAll('input,select,textarea,button[type="submit"]').forEach(el => el.disabled = true);
        }
      })();

      // 送信
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!form.checkValidity()) { form.reportValidity(); return; }

        const discover = document.querySelector('input[name="discover"]:checked')?.value;
        const t = (currentConfig.q2?.type) || 'likert';
        let q2Value = null;
        if (t === 'likert' || t === 'single') {
          q2Value = document.querySelector('input[name="q2"]:checked')?.value;
        } else if (t === 'multiple') {
          q2Value = Array.from(document.querySelectorAll('input[name="q2_multi"]:checked')).map(el => el.value);
          if (q2Value.length === 0) { alert('少なくとも1つ選んでください'); return; }
        } else if (t === 'matrix') {
          const rows = currentConfig.q2.matrix?.rows || []; const mode = currentConfig.q2.matrix?.selectMode || 'single'; const ans = {};
          for (let ri = 0; ri < rows.length; ri++) {
            if (mode === 'single') {
              const v = document.querySelector(`input[name="q2_row_${ri}"]:checked`)?.value; if (!v) { alert('各行から1つずつ選択してください'); return; } ans[String(rows[ri])] = v;
            } else {
              const arr = Array.from(document.querySelectorAll(`input[name="q2_row_${ri}_m"]:checked`)).map(el => el.value); if (arr.length === 0) { alert('各行で1つ以上選択してください'); return; } ans[String(rows[ri])] = arr;
            }
          }
          q2Value = ans;
        } else if (t === 'short') {
          const cfg = currentConfig.q2.short || {}; const v = (document.querySelector('input[name="q2"]')?.value || '').trim(); if (!validateByPresetAndPattern(v, cfg.preset, cfg.pattern)) { return; } q2Value = v;
        } else if (t === 'long') {
          const cfg = currentConfig.q2.long || {}; const v = (document.querySelector('textarea[name="q2"]')?.value || '').trim(); if (!validateByPresetAndPattern(v, cfg.preset, cfg.pattern)) { return; } q2Value = v;
        }

        alert(`送信ありがとうございました\nQ1: ${discover}\nQ2: ${formatValue(q2Value)}`);
        const key = submitKey; const all = JSON.parse(localStorage.getItem(key) || '[]');
        all.push({ ts: new Date().toISOString(), projectId: project?.id || null, surveyId, q1: discover ?? '', q2Type: t, q2Value });
        localStorage.setItem(key, JSON.stringify(all));
        form.reset(); updateQ2();
      });

      function validateByPresetAndPattern(value, preset, pattern) {
        let re = null;
        if (pattern) { try { re = new RegExp(pattern); } catch { alert('不正な正規表現です'); return false; } }
        else if (preset) {
          if (preset === 'numeric') re = /^\d+$/;
          else if (preset === 'alpha') re = /^[A-Za-z]+$/;
          else if (preset === 'alnum') re = /^[A-Za-z0-9]+$/;
          else if (preset === 'email') re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        }
        if (re && !re.test(value)) { alert('入力形式が正しくありません'); return false; }
        return true;
      }
      function escapeHtml(str) { return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
      function formatValue(v) { if (v == null) return ''; if (Array.isArray(v)) return v.join(', '); if (typeof v === 'object') return Object.entries(v).map(([k,val]) => `${k}: ${val}`).join(' / '); return String(v); }
    </script>
  </body>
</html>

